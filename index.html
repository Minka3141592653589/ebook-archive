<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>eBook Archive</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>eBook Archive</h1>

  <div>
    <label for="language">Filter by language:</label>
    <select id="language">
      <option value="all">All</option>
    </select>

    <label for="author">Filter by author:</label>
    <select id="author">
      <option value="all">All</option>
    </select>

    <div id="stats">
      <div id="count-total"></div>
      <div id="count-filtered"></div>
      <div id="count-languages"></div>
      <div id="count-authors"></div>
    </div>
  </div>

  <div>
    <button id="sort-title">Sort by Title</button>
    <button id="sort-author">Sort by Author</button>
  </div>

  <ul id="book-list"></ul>

  <script>
  document.addEventListener("DOMContentLoaded", () => {

    let booksData = [];
    let filteredData = [];
    const list = document.getElementById("book-list");
    const languageSelect = document.getElementById("language");
    const authorSelect = document.getElementById("author");
    const countTotal = document.getElementById("count-total");
    const countFiltered = document.getElementById("count-filtered");
    const countLanguages = document.getElementById("count-languages");
    const countAuthors = document.getElementById("count-authors");

    function renderStats() {
      countTotal.textContent = `Total eBooks: ${booksData.length}`;
      countFiltered.textContent = `Shown eBooks: ${filteredData.length}`;

      const langCounts = {};
      for (const b of filteredData) {
        langCounts[b.lang] = (langCounts[b.lang] || 0) + 1;
      }

      countLanguages.innerHTML =
        "By language: " +
        Object.entries(langCounts)
          .map(([l, c]) => `${l.toUpperCase()} (${c})`)
          .join(", ");

      const authorCounts = {};
      for (const b of filteredData) {
        authorCounts[b.author] = (authorCounts[b.author] || 0) + 1;
      }

      countAuthors.innerHTML =
        "By author: " +
        Object.entries(authorCounts)
          .sort((a, b) => a[0].localeCompare(b[0]))
          .map(([a, c]) => `${a} (${c})`)
          .join(", ");
    }

    function renderBooks(data) {
      list.innerHTML = "";
      for (const book of data) {
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = `book.html?book=${book.slug}`;
        a.textContent = `${book.author} â€“ ${book.title}`;
        li.appendChild(a);
        list.appendChild(li);
      }
      renderStats();
    }

    function updateFilteredData() {
      const selectedLang = languageSelect.value;
      const selectedAuthor = authorSelect.value;

      filteredData = booksData.filter(book => {
        if (selectedLang !== "all" && book.lang !== selectedLang) return false;
        if (selectedAuthor !== "all" && book.author !== selectedAuthor) return false;
        return true;
      });

      renderBooks(filteredData);
    }

    fetch("books.json")
      .then(r => r.json())
      .then(books => {
        booksData = books;
        const langs = [...new Set(books.map(b => b.lang))];
        for (const lang of langs) {
          const option = document.createElement("option");
          option.value = lang;
          option.textContent = lang.toUpperCase();
          languageSelect.appendChild(option);
        }
        const authors = [...new Set(books.map(b => b.author))].sort();
        for (const author of authors) {
        const option = document.createElement("option");
        option.value = author;
        option.textContent = author;
        authorSelect.appendChild(option);
        }


        updateFilteredData();
      });
    languageSelect.addEventListener("change", updateFilteredData);
    authorSelect.addEventListener("change", updateFilteredData);

    document.getElementById("sort-title").addEventListener("click", () => {
      filteredData.sort((a, b) => a.title.localeCompare(b.title));
      renderBooks(filteredData);
    });

    document.getElementById("sort-author").addEventListener("click", () => {
      filteredData.sort((a, b) => a.author.localeCompare(b.author));
      renderBooks(filteredData);
    });

  });
  </script>
</body>
</html>
